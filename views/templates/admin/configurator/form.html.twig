{% extends '@Modules/drsoftfrproductwizard/views/templates/admin/base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap4.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    {% if manifest is defined %}
        <script src="{{ asset('../modules/drsoftfrproductwizard/views/' ~ manifest.url('src/js/admin/configurator/form/head.js')['file']) }}"
                async defer></script>
    {% endif %}

    <style>
        /* Style de base pour les éléments de la liste */
        .sortable-list > * {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        /* Style pour l'élément fantôme (emplacement où l'item sera déposé) */
        .sortable-ghost {
            background-color: #f8f9fa !important;
            border: 2px dashed #ccc !important;
            opacity: 0.7 !important;
        }

        /* Style pour l'élément actuellement sélectionné et déplacé */
        .sortable-chosen {
            background-color: #fff !important;
        }

        /* Style pour l'élément en cours de déplacement */
        .sortable-drag {
            background-color: #fff !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
            opacity: 0.9 !important;
            max-height: 50px !important;
            overflow: hidden !important;
            z-index: 9999 !important;
            border-radius: 4px !important;
        }
    </style>
{% endblock %}

{% block main %}
    <div class="row justify-content-center" x-data="{}">
        <div class="col">
            <div class="card">
                <h1 class="card-header">{{ form.vars.value.id ? 'Éditer le scénario' : 'Créer un scénario' }}</h1>
                <div class="card-body">
                    {{ form_start(form) }}
                    {{ form_errors(form) }}
                    <div class="form-group mb-3">
                        {{ form_row(form.name) }}
                        {{ form_row(form.active) }}
                    </div>

                    <div x-data="window.drsoftfrproductwizard.alpine.stepManager({{ form.steps|length }})">
                        <h2 class="mb-2">Étapes du scénario</h2>
                        <div id="steps-collection" class="sortable-list">
                            {% for step_form in form.steps %}
                                {% include '@Modules/drsoftfrproductwizard/views/templates/admin/configurator/_step_form.html.twig' with { step_form, 'step_id': step_form.vars.value.id, 'step_iteration': loop.index0 } %}
                            {% else %}
                                <div class="alert alert-info">Aucune étape définie pour ce scénario.</div>
                            {% endfor %}
                        </div>

                        <template id="step-prototype">
                            {% include '@Modules/drsoftfrproductwizard/views/templates/admin/configurator/_step_form.html.twig' with { 'step_form': form.steps.vars.prototype, 'step_id': '__step__', 'step_iteration': '__step__' } %}
                        </template>
                        <button type="button" class="btn btn-outline-primary mt-2" @click="addStep">Ajouter une
                            étape
                        </button>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-success">Enregistrer</button>
                        <a class="btn btn-secondary"
                           href="{{ path('admin_drsoft_fr_product_wizard_configurator_index') }}">Retour</a>
                    </div>

                    {% if form._token is defined %}
                        {{ form_widget(form._token) }}
                    {% endif %}

                    {{ form_end(form, {render_rest: false}) }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    {% if manifest is defined %}
        <script src="{{ asset('../modules/drsoftfrproductwizard/views/' ~ manifest.url('src/js/admin/configurator/form/footer.js')['file']) }}"
                async defer></script>
    {% endif %}
{% endblock %}